---
title: "Analysis on isolates used in pairwise competitions"
author: "Chang-Yu Chang"
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: yes
    number_sections: no
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(cache = TRUE, echo = FALSE)
library(tidyverse)
library(data.table)
library(ggtree)
communities <- fread(here::here("data/output/communities.csv"))
communities_name <- communities$Community
communities_size <- communities$CommunitySize
```


# Read data

```{r}
source("script/01-isolates-01-read_match_isolate.R")
```

Isolates information in one dataframe `isolates`. 68 isolates

```{r}
isolates
str(isolates)
```

For ploting growth rates data, use the melted isolate dataframe `isolates_melted`. 719 rows

```{r}
isolates_melted
str(isolates_melted)
```


# Plot isolates' function distribution

R functions for plotting

```{r}
plot_isolate_histogram <- function (isolates, value_by = "OD620", fill_by = "Fermenter") {
  if (fill_by == "Family") {
    temp_isolates <- filter(isolates, Family %in% c("Enterobacteriaceae", "Pseudomonadaceae")) 
    } else temp_isolates <- isolates

  temp_isolates %>%
    ggplot(aes_string(group = fill_by)) +
    geom_histogram(aes_string(x = value_by, fill = fill_by), bins = 20, position = "dodge", col = "black") +
    theme_bw() +
    theme(legend.position = "top")
}

plot_isolate_distribution <- function (isolates, value_by = "OD620", fill_by = "Fermenter") {
  if (fill_by == "Family") {
    temp_isolates <- filter(isolates, Family %in% c("Enterobacteriaceae", "Pseudomonadaceae")) 
    } else temp_isolates <- isolates

  temp_isolates %>%
    ggplot(aes_string(group = fill_by)) +
    geom_density(mapping = aes_string(x = value_by, col = fill_by), lwd = 2) +
    theme_bw() +
    theme(legend.position = "top")
}
```


OD by fermentation

```{r}
plot_isolate_histogram(isolates, value_by = "OD620", fill_by = "Fermenter") 
plot_isolate_distribution(isolates, value_by = "OD620", fill_by = "Fermenter")
```


OD by family

```{r}
plot_isolate_histogram(isolates, value_by = "OD620", fill_by = "Family") 
plot_isolate_distribution(isolates, value_by = "OD620", fill_by = "Family")
```

Maximal growth rates by fermentation

```{r}
isolates_melted %>%
  filter(!is.na(Fermenter)) %>%
  ggplot(aes(group = Fermenter)) +
  geom_density(aes(x = MaxGrowthRate, y = ..density.., col = Fermenter), lwd = 2) +
  facet_wrap(CarbonSource~., scale = "free", ncol = 3) +
  theme_bw() +
  theme(legend.position = "top")
```




Maximal growth rates by family

```{r fig.width=5, fig.height=8}
p_isolates_growth_rate <- isolates_melted %>%
  filter(Family %in% c("Enterobacteriaceae", "Pseudomonadaceae")) %>%
  ggplot(aes(group = Family)) +
  geom_density(aes(x = MaxGrowthRate, y = ..density.., col = Family), lwd = 2) +
  facet_wrap(CarbonSource~., scale = "free", ncol = 3) +
  theme_bw() +
  theme(legend.position = "top")

p_isolates_growth_rate
if (write_all_csv) fwrite(isolates_growth_rate_ID_RDP, root$find_file("data/temp/isolates_growth_rate_ID_RDP.csv"))
```




# Plot isolates' tree and traits

```{r}
source("script/01-isolates-03-phylogeny_growth_trait.R")
```

```{r, fig.width=4, fig.height=6}
p_heat
```


```{r, fig.width=4}
p_heat_large
```





```{r}
pdf(root$find_file("output/figure/isolates_phylogency.pdf"), width = 10, height = 12); p_heat; invisible(dev.off())
```



# Correlate isolates' traits


```{r}
isolates %>%
  ggplot() +
  geom_point(aes(x = OD620, y = Rank)) +
#  geom_smooth(aes(x = OD620, y = Rank)) +
  facet_wrap(Community~., scale = "free") +
  theme_bw()
```





