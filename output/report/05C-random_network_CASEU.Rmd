---
title: "Random network CASEU"
author: "Chang-Yu Chang"
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: yes
    number_sections: no
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(cache = TRUE, echo = FALSE)
library(tidyverse)
library(data.table)
library(cowplot)
# 
communities <- fread(here::here("data/output/communities.csv"))
communities_name <- communities$Community
communities_size <- communities$CommunitySize
isolates <- fread(here::here("data/output/isolates.csv"))
isolates_random <- fread(here::here("data/output/isolates_random.csv"))
#jean_isolates_RDP <- fread(here::here("data/temp/jean_isolates_RDP.csv"))
```

This Rmd processes the raw data from CASEU and return table of isolate frequencies in csv file form.


# Random network, CASEU batch 1

- Genewiz submisstion code: Caseu_RN_1
- Plate layout: T3 C P2
- Description: samples 3, 4, 5, 12, 13, 27, 29, 33, 73, 85, 86, 91, and 94 (order by column in the plate layout) arrived Genewiz dry, so they are not processed.

```{r eval = F}
source("script/05C-random_network_CASEU-01-batch1.R")
```


```{r}
p <- CASEU_RN1 %>%
  mutate(T0 = Isolate1Freq, T3 = Isolate1FreqPredicted, InitialFrequency = factor(T0)) %>% 
  select(Community, Isolate1, Isolate2, InitialFrequency, T0, T3) %>%
  pivot_longer(cols = c(T0, T3), names_to = "Transfer", values_to = "Isolate1Freq") %>%
  mutate(Transfer = ordered(Transfer, levels = c("T0", "T3"))) %>%
  ggplot(aes(x = Transfer, y = Isolate1Freq, color = InitialFrequency, group = InitialFrequency)) +
  geom_point() + geom_line() +
  facet_grid(Isolate1 ~ Isolate2) + 
  scale_y_continuous(limits = c(0,1)) +
  theme_bw() +
  ggtitle("Random network 1") +
  labs(x = "transfer", y = "isolate1 frequency")

```

```{r}
ggsave(here::here("output/report/figure/05C-random_netowkr_CASEU-caseu_RN1.pdf"), p, width = 12, height = 10)
```


# Random network, CASEU batch2

- Genewiz submisstion code: Caseu_RN_2
- Plate layout: T3 C P2
- Description: this plate layout contains the isolates for all 4 random assembled communities 

```{r}
source("script/05C-random_network_CASEU-02-batch2.R")
```

```{r}
CASEU_RN2 <- fread(here::here("data/temp/CASEU_RN2.csv"))
p_temp <- CASEU_RN2 %>%
  mutate(T0 = Isolate1Freq, T3 = Isolate1FreqPredicted, InitialFrequency = factor(T0)) %>% 
  select(Community, Isolate1, Isolate2, InitialFrequency, T0, T3) %>%
  pivot_longer(cols = c(T0, T3), names_to = "Transfer", values_to = "Isolate1Freq") %>%
  mutate(Transfer = ordered(Transfer, levels = c("T0", "T3"))) %>%
  ggplot(aes(x = Transfer, y = Isolate1Freq, color = InitialFrequency, group = InitialFrequency)) +
  geom_point() + geom_line() +
  facet_grid(Isolate1 ~ Isolate2) + 
  scale_y_continuous(limits = c(0,1)) +
  theme_bw() +
  ggtitle("Random network 1") +
  labs(x = "transfer", y = "isolate1 frequency")

p_temp
```
```{r}
load(here::here("data/temp/CASEU_RN2_raw_output.Rdata"))
which(is.na(CASEU_RN2_raw_output))
CASEU_RN2_mixture_list
```


# Random network, CASEU batch3

- Genewiz submisstion code: Caseu_RN_3
- Plate layout: 
    - P1 (T0 C P2), tracking number 30-333649143
    - P2 (T0 AD P2), tracking number 30-333649365
    - P3 (T3 AD P2), tracking number 30-333649517
- Description: AD plates have the isolates assembled from the self-assembled communities but different communities

```{r eval = F}
source("script/05C-random_network_CASEU-03-batch3.R")
```

Use T0 OD frequencies

```{r}
CASEU_RN3 <- fread(here::here("data/temp/CASEU_RN3.csv"))
temp <- CASEU_RN3 %>% 
  filter(Community == "AcrAss1") %>%
  mutate(InitialFrequency = factor(Isolate1Freq), Time = ordered(Time, c("T0", "T3")))

temp$Isolate1FreqPredicted[temp$Time == "T0"] <- temp$Isolate1Freq[temp$Time == "T0"]
  
temp %>%
  select(Time, Community, Isolate1, Isolate2, InitialFrequency, Isolate1FreqPredicted) %>%
  arrange(Isolate1, Isolate2, InitialFrequency, Time) %>%
  ggplot(aes(x = Time, y = Isolate1FreqPredicted, color = InitialFrequency, group = InitialFrequency)) +
  geom_point() + geom_line() +
  facet_grid(Isolate1 ~ Isolate2) + 
  scale_y_continuous(limits = c(0,1)) +
  theme_bw() +
  ggtitle("AcrAss1") +
  labs(x = "transfer", y = "isolate1 frequency")
```


Use CASEU predicted frequencies

```{r}
CASEU_RN3 %>% 
  filter(Community == "AcrAss1") %>%
  mutate(InitialFrequency = factor(Isolate1Freq), Time = ordered(Time, c("T0", "T3"))) %>%
  select(-Sample, -Mixture, -RSquare, -Isolate2FreqPredicted) %>%
  select(Time, Community, Isolate1, Isolate2, InitialFrequency, Isolate1FreqPredicted) %>%
  arrange(Isolate1, Isolate2, InitialFrequency, Time) %>%
  ggplot(aes(x = Time, y = Isolate1FreqPredicted, color = InitialFrequency, group = InitialFrequency)) +
  geom_point() + geom_line() +
  facet_grid(Isolate1 ~ Isolate2) + 
  scale_y_continuous(limits = c(0,1)) +
  theme_bw() +
  ggtitle("AcrAss1") +
  labs(x = "transfer", y = "isolate1 frequency")
```


# Random network, caseu batch 4

- Genewiz submisstion code: Caseu_RN_4
- Plate layout: T3 BD P3
- Description: This plate has the full AcrAss2 (B) and half of RanAss2 (D) network.


```{r}
source("script/05C-random_network_CASEU-02-batch4.R")
```




















