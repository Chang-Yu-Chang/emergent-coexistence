---
title: "Analysis on the empirical random invasion networks"
author: "Chang-Yu Chang"
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: yes
    number_sections: no
---

```{r setup, include = F}
knitr::opts_chunk$set(cache = FALSE, echo = FALSE)

library(tidyverse)
library(data.table)
library(cowplot)
library(igraph)
library(tidygraph)
library(ggraph)
source(here::here("plotting_scripts/network_functions.R"))
run_scripts <- F
communities <- read_csv(here::here("data/output/communities.csv"))

# communities <- read_csv(here::here("data/temp/communities.csv"))
# communities_name <- communities$Community
# communities_size <- communities$CommunitySize
# random_network_communities_name <- c("AcrAss1", "AcrAss2", "RanAss1", "RanAss2")
# random_network_communities_size <- rep(7, 4) 
# isolates_ID_match <- read_csv(here::here("data/temp/isolates_ID_match.csv"))
# isolates <- read_csv(here::here("data/output/isolates.csv"))
# jean_isolates_RDP <- read_csv(here::here("data/temp/jean_isolates_RDP.csv"))

```

# Introduction

- The R scripts (sourced in this Rmd) can be run externally to Rstudio.
- The R scripts are only for saving R functions, processing raw and temporary data.
- All visualization codes are in this Rmd file.


# 04A-random_network_experiment

## Pick isolates
4 communities, 8 isolates each. 16 isolates are from random isolate from Jean's collection, and 16 isolates are from self-assembled communities

```{r}
if (run_scripts) source("script/04A-random_network_experiment-01-pick_isolates.R")
```

```{r}
isolates_random <- read_csv(here::here("data/output/isolates_random.csv"))
isolates_random
```


## Map plate layout

```{r}
if (run_scripts) source("script/04A-random_network_experiment-02-map_plate_layout.R")
```

```{r}

pdf(here::here("output/report/figure/05B-random_network_OD-plate_layout.pdf"), width = 15, height = 12);
plot_grid(plotlist = p_random_network_plates_list, ncol = 3, nrow = 3, , labels = names(p_random_network_plates_list)); invisible(dev.off())
```


```{r}
if (write_all_csv) write_csv(random_assembly_plates, file = here::here("data/temp/random_assembly_plates.csv"))
save(p_random_network_plates_list, file = here::here("data/temp/random_network_plate_layout.RData"))
```

## Read OD data

```{r warning = F}
if (run_scripts) source("script/04A-random_network_experiment-03-read_OD_data.R")
OD
```

```{r message = F, warning = F, fig.width=5, fig.height = 4}
# Plot the OD 
p_random_network_OD <- rep(list(NA), 4)
for (i in 1:4) {
  p_random_network_OD[[i]] <- 
    OD %>% 
    filter(Community == random_community_names[i], Wavelength == 620) %>% 
    mutate(Transfer = as.numeric(gsub("T", "", Transfer))) %>% 
    #  replace_na(replace = list(Isolate1Freq = "mono", Isolate2Freq = "mono")) %>%
    group_by(Transfer, Community, Isolate1, Isolate2, Isolate1Freq) %>% 
    summarize(AbsMean = mean(Abs), AbsSd = sd(Abs)) %>% 
    ggplot(aes(x = Transfer, y = AbsMean, color = Isolate1Freq)) +
    geom_point() + geom_line() +
    geom_segment(aes(x = Transfer, xend = Transfer, y = AbsMean + AbsSd, yend = AbsMean - AbsSd)) +
    scale_x_continuous(breaks = 0:10, limits = c(0, 4)) + 
    facet_grid(Isolate1 ~ Isolate2) +
    theme_bw() +
    ggtitle(random_community_names[i])
}
p_random_network_OD
```

```{r}
OD %>% 
  filter(Community == "EP", Wavelength == 620) %>% 
  mutate(Transfer = as.numeric(gsub("T", "", Transfer))) %>% 
  #  replace_na(replace = list(Isolate1Freq = "mono", Isolate2Freq = "mono")) %>%
  group_by(Transfer, Community, Isolate1, Isolate2, Isolate1Freq) %>%
  summarize(AbsMean = mean(Abs), AbsSd = sd(Abs)) %>% 
  ggplot(aes(x = Transfer, y = AbsMean, color = Isolate1Freq)) +
  geom_point() + geom_line() +
  scale_x_continuous(breaks = 0:10, limits = c(0, 3)) + 
  facet_grid(Isolate1 ~ Isolate2) +
  theme_bw()
```



Check contamination

```{r}
OD %>% 
  filter(Wavelength == 620, Community != "blank") %>% 
  filter(Isolate1 == Isolate2) %>%
  group_by(Community, Isolate1) %>% 
  ggplot() +
  geom_point(aes(x = Isolate1, y = Abs, color = Isolate1Freq)) +
  facet_grid(Transfer ~ Community , scales = "free_y") +
  theme_bw()
  
```



# 04B-random_netowkr_CASEU
This Rmd processes the raw data from CASEU and return table of isolate frequencies in csv file form.


## Random network, CASEU batch 1

- Genewiz submisstion code: Caseu_RN_1
- Plate layout: T3 C P2
- Description: samples 3, 4, 5, 12, 13, 27, 29, 33, 73, 85, 86, 91, and 94 (order by column in the plate layout) arrived Genewiz dry, so they are not processed.

```{r eval = F}
if (run_scripts) source("script/05C-random_network_CASEU-01-batch1.R")
```


```{r}
p <- CASEU_RN1 %>%
  mutate(T0 = Isolate1Freq, T3 = Isolate1FreqPredicted, InitialFrequency = factor(T0)) %>% 
  select(Community, Isolate1, Isolate2, InitialFrequency, T0, T3) %>%
  pivot_longer(cols = c(T0, T3), names_to = "Transfer", values_to = "Isolate1Freq") %>%
  mutate(Transfer = ordered(Transfer, levels = c("T0", "T3"))) %>%
  ggplot(aes(x = Transfer, y = Isolate1Freq, color = InitialFrequency, group = InitialFrequency)) +
  geom_point() + geom_line() +
  facet_grid(Isolate1 ~ Isolate2) + 
  scale_y_continuous(limits = c(0,1)) +
  theme_bw() +
  ggtitle("Random network 1") +
  labs(x = "transfer", y = "isolate1 frequency")

```

```{r}
ggsave(here::here("output/report/figure/05C-random_netowkr_CASEU-caseu_RN1.pdf"), p, width = 12, height = 10)
```


## Random network, CASEU batch2

- Genewiz submisstion code: Caseu_RN_2
- Plate layout: T3 C P2
- Description: this plate layout contains the isolates for all 4 random assembled communities 

```{r}
source("script/05C-random_network_CASEU-02-batch2.R")
```

```{r}
CASEU_RN2 <- read_csv(here::here("data/temp/CASEU_RN2.csv"))
p_temp <- CASEU_RN2 %>%
  mutate(T0 = Isolate1Freq, T3 = Isolate1FreqPredicted, InitialFrequency = factor(T0)) %>% 
  select(Community, Isolate1, Isolate2, InitialFrequency, T0, T3) %>%
  pivot_longer(cols = c(T0, T3), names_to = "Transfer", values_to = "Isolate1Freq") %>%
  mutate(Transfer = ordered(Transfer, levels = c("T0", "T3"))) %>%
  ggplot(aes(x = Transfer, y = Isolate1Freq, color = InitialFrequency, group = InitialFrequency)) +
  geom_point() + geom_line() +
  facet_grid(Isolate1 ~ Isolate2) + 
  scale_y_continuous(limits = c(0,1)) +
  theme_bw() +
  ggtitle("Random network 1") +
  labs(x = "transfer", y = "isolate1 frequency")

p_temp
```
```{r}
load(here::here("data/temp/CASEU_RN2_raw_output.Rdata"))
which(is.na(CASEU_RN2_raw_output))
CASEU_RN2_mixture_list
```


## Random network, CASEU batch3

- Genewiz submisstion code: Caseu_RN_3
- Plate layout: 
    - P1 (T0 C P2), tracking number 30-333649143
    - P2 (T0 AD P2), tracking number 30-333649365
    - P3 (T3 AD P2), tracking number 30-333649517
- Description: AD plates have the isolates assembled from the self-assembled communities but different communities

```{r eval = F}
if (run_scripts) source("script/05C-random_network_CASEU-03-batch3.R")
```

Use T0 OD frequencies

```{r}
CASEU_RN3 <- read_csv(here::here("data/temp/CASEU_RN3.csv"))
temp <- CASEU_RN3 %>% 
  filter(Community == "AcrAss1") %>%
  mutate(InitialFrequency = factor(Isolate1Freq), Time = ordered(Time, c("T0", "T3")))

temp$Isolate1FreqPredicted[temp$Time == "T0"] <- temp$Isolate1Freq[temp$Time == "T0"]
  
temp %>%
  select(Time, Community, Isolate1, Isolate2, InitialFrequency, Isolate1FreqPredicted) %>%
  arrange(Isolate1, Isolate2, InitialFrequency, Time) %>%
  ggplot(aes(x = Time, y = Isolate1FreqPredicted, color = InitialFrequency, group = InitialFrequency)) +
  geom_point() + geom_line() +
  facet_grid(Isolate1 ~ Isolate2) + 
  scale_y_continuous(limits = c(0,1)) +
  theme_bw() +
  ggtitle("AcrAss1") +
  labs(x = "transfer", y = "isolate1 frequency")
```


Use CASEU predicted frequencies

```{r}
CASEU_RN3 %>% 
  filter(Community == "AcrAss1") %>%
  mutate(InitialFrequency = factor(Isolate1Freq), Time = ordered(Time, c("T0", "T3"))) %>%
  select(-Sample, -Mixture, -RSquare, -Isolate2FreqPredicted) %>%
  select(Time, Community, Isolate1, Isolate2, InitialFrequency, Isolate1FreqPredicted) %>%
  arrange(Isolate1, Isolate2, InitialFrequency, Time) %>%
  ggplot(aes(x = Time, y = Isolate1FreqPredicted, color = InitialFrequency, group = InitialFrequency)) +
  geom_point() + geom_line() +
  facet_grid(Isolate1 ~ Isolate2) + 
  scale_y_continuous(limits = c(0,1)) +
  theme_bw() +
  ggtitle("AcrAss1") +
  labs(x = "transfer", y = "isolate1 frequency")
```


## Random network, caseu batch 4

- Genewiz submisstion code: Caseu_RN_4
- Plate layout: T3 BD P3
- Description: This plate has the full AcrAss2 (B) and half of RanAss2 (D) network.


```{r}
if (run_scripts) source("script/05C-random_network_CASEU-02-batch4.R")
```


## Random netwokr, caseu batch 5

- Genewiz submisstion code: 
- Plate layout: T3 BD P3
    - T0 BD P2
    - T3 C P3
- Description: XX

```{r}
```



# 04C-random_network_interaction

This Rmd reads the processed CASEU output, adds the isolate properties to the pairs, determines the pairwise interaction types, then determine the network properties.  

## Determine interaction types

```{r}
if (run_scripts) source("script/05D-random_network_interaction-01-determine_interactions.R")
```



```{r}
pairs_random
pairs_random_frequency
```

```{r}
pairs_random %>%
  group_by(Community, InteractionType) %>% 
  summarize(Count = n())
```

```{r}
plot_frequency <- function(pairs_melted) {
  pairs_melted %>%
    mutate(Isolate = factor(Isolate1, 1:8), Isolate2 = factor(Isolate2, 1:8)) %>%
    mutate(Isolate1InitialODFreq = factor(Isolate1InitialODFreq)) %>%
    ggplot(aes(x = Time, y = Isolate1MeasuredFreq, color = Isolate1InitialODFreq, group = Isolate1InitialODFreq)) +
    geom_line() +
    geom_point() +
    facet_grid(Isolate1~Isolate2) +
    theme_bw() +
    theme(legend.position = "top")
} 

p1 <- pairs_random_melted %>%
  filter(Community == "AcrAss1") %>%
  plot_frequency() +
  ggtitle("AcrAss1")
p2 <- pairs_random_melted %>%
  filter(Community == "AcrAss2") %>%
  plot_frequency() +
  theme(legend.position = "none") +
  ggtitle("AcrAss2")
p3 <- pairs_random_melted %>%
  filter(Community == "RanAss1") %>%
  plot_frequency() +
  theme(legend.position = "none") +
  ggtitle("RanAss1")
p4 <- pairs_random_melted %>%
  filter(Community == "RanAss2") %>%
  plot_frequency() +
  theme(legend.position = "none") +
  ggtitle("RanAss2") 


p <- plot_grid(p1, p2, p3, p4, nrow = 2)
ggsave(here::here("output/report/figure/05D-random_network_interaction-frequency.png"), p, width = 12, height = 12)
```


## Determine network properties


```{r message = F, eval = F}
if (run_scripts) source("script/05D-random_network_interaction-02-network_properties.R")
```


Matrix

```{r}
p_random_network_matrix_list <- net_random_list %>% lapply(plot_adjacent_matrix)
p <- plot_grid(plotlist = p_random_network_matrix_list, nrow = 1)
ggsave(here::here("output/report/figure/05D-random_network_interaction-adjacent_matrix.png"), p, width = 8, height = 4)

```

Network motif

```{r}
ggsave(here::here("output/report/figure/05D-random_network_interaction-motif.png"), p_net_random_motif_randomized, width = 8, height = 4)
```
































# Summary



## Fraction of pairwise coexistence within community  

```{r message = F}
pairs <- read_csv(here::here("data/output/pairs.csv"))
random_network_pairs <- read_csv(here::here("data/temp/random_network_pairs.csv"))
pairs_combined <- select(pairs, names(random_network_pairs)) %>%
  bind_rows(random_network_pairs)
```


```{r}
communities_pair_coext <- pairs_combined %>%
  mutate(Community = ordered(Community, levels = c(communities_name, random_network_communities_name))) %>%
  filter(InteractionType != "") %>%
  filter(InteractionType %in% c("exclusion", "coexistence")) %>%
  group_by(Community, InteractionType) %>%
  summarize(Count = n()) %>%
  spread(InteractionType, Count) %>%
  mutate(FracCoext = coexistence / (coexistence + exclusion)) %>%
  ungroup() %>%
  mutate(CommunitySize = c(communities_size, random_network_communities_size[3]))

communities_pair_coext$FracCoext[is.na(communities_pair_coext$FracCoext)] <- 0
```

Fraction of coexistence in 13 communities

```{r}
p_communities_pair_coext <- 
communities_pair_coext %>%
  ggplot() +
  geom_bar(aes(x = Community, y = FracCoext), stat = "identity", col = 1) +
  scale_y_continuous(limits = c(0, 1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "community", y = "fraction of coexistence")

p_communities_pair_coext
pdf(here::here("output/figure/communities_fraction_coexistence.pdf"), width = 5, height = 3); p_communities_pair_coext; invisible(dev.off())
```

## Community hierarchy in communities


From Higgins2017, the competitive score $s_i$ of each strain $i$ was defined as its mean fraction $f_{ij}$ after co-culture with each of the $n-1$ competitor strains:

$$s_i=(\sum_{i\neq j}f_{ij})/(n-1)$$

The hierarchy score $h$ for an n-member network is calculated as:

$$h = \sum_{s_i>s_j}f_{ij}$$

```{r}
communities_hierarchy <- read_csv(here::here("data/temp/communities_hierarchy.csv"))

p_communities_hierarchy <- communities_hierarchy %>%
  ggplot() +
  geom_bar(aes(x = Community, y = HierarchyScore), stat = "identity", col = 1) +
  scale_y_continuous(limits = c(0, 1)) +
  theme_bw() +
  theme(axis.text.x = element_text(angle = 90)) +
  labs(x = "community", y = "hierarchy score")

p_communities_hierarchy
pdf(here::here("output/figure/communities_hierarchy.pdf"), width = 5, height = 3); p_communities_hierarchy; invisible(dev.off())

    
```



## EP pair

```{r}
EP_pairs <- read_csv(here::here("data/raw/pairwise_competition/EP_pairs.csv")) %>% 
  mutate(Isolate1Freq = Isolate1Colony / (Isolate1Colony + Isolate2Colony))

p_temp <- EP_pairs %>% mutate(Time = "T3") %>% 
  bind_rows(EP_pairs %>% mutate(Time = "T0", Isolate1Freq = Isolate1InitialODFreq/100)) %>% 
  mutate(Isolate1InitialODFreq = factor(Isolate1InitialODFreq), Time = ordered(Time)) %>% 
  filter(Replicate == "a") %>% 
  select(Isolate1InitialODFreq, Time, Isolate1Freq) %>%
  group_by(Isolate1InitialODFreq) %>% 
  ggplot(aes(x = Time, y = Isolate1Freq, color = Isolate1InitialODFreq, group = Isolate1InitialODFreq)) +
  geom_point() + geom_line() +
  theme_bw() +
  theme(legend.position = "top") +
  labs(y = "E frequenency")


pdf(here::here("output/report/figure/05-random_network-EP_pairs.pdf")); p_temp; invisible(dev.off())
```














