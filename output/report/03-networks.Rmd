---
title: "Analysis on the empirical networks"
author: "Chang-Yu Chang"
date: "`r Sys.Date()`"
output:
  html_notebook:  
    toc: yes
    number_sections: no
---

```{r setup, include = F}
knitr::opts_chunk$set(cache = FALSE, echo = FALSE)
library(tidyverse)
library(cowplot)
library(igraph)
library(tidygraph)
library(ggraph)
source(here::here("plotting_scripts/misc.R"))
run_scripts <- F
```

# Introduction

- The R scripts (sourced in this Rmd) can be run externally to Rstudio.
- The R scripts are only for saving R functions, processing raw and temporary data.
- All visualization codes are in this Rmd file.

# 03A-make_network

- Make community network from `data/output/pairs.csv`.

- Plot networks and matrices

## Make network

```{r}
if (run_scripts) source("script/03A-make_network-01-make_pairwise_network.R")
```


Networks in matrix form


```{r fig.width=10, fig.height=1}
p_list <- lapply(communities_network$Network, plot_adjacent_matrix)
plot_grid(plotlist = p_list, labels = 1:13, nrow = 1, scale = .9)
```


Networks in graph

```{r fig.width=10, fig.height=1, warning=F}
p_list <- lapply(communities_network$Network, function(x) plot_competitive_network(x, node_size = 0))
plot_grid(plotlist = p_list, labels = 1:13, nrow = 1, hjust = 1)
```



## Randomize networks

```{r}
# It takes ~850 seconds = 15 mins to randomize 1000 times
if (run_scripts) source("script/03A-make_network-03-randomize_network.R")
```

C11R2
Left: observation
Right: one randomized network

```{r fig.width = 4, fig.height = 2}
load("~/Dropbox/lab/emergent-coexistence/data/output/communities_network_randomized.Rdata")
p1 <- communities_network_randomized %>% 
    filter(Community == "C11R2") %>% 
    pull(Network) %>% `[[`(1) %>% 
    plot_adjacent_matrix(show.legend = T) + 
    theme(legend.title = element_blank())
p2 <- communities_network_randomized$NetworkRandomized$C11R2[[1]] %>% plot_adjacent_matrix()
plot_grid(p1, p2, nrow = 1, axis = "tb", align = "h")
```


# 03B-network_measure

## Detect motifs in networks

```{r}
if (run_scripts) source("script/03B-network_measure-01-detect_motif.R")
```

- `communities_motif`: data.frame
- `networks_motif_randomized`: data.frame for all randomized networks motif counts

Empirical network motifs. 13 communities x 7 motifs = 91 rows

```{r}
read_csv("~/Dropbox/lab/emergent-coexistence/data/output/communities_motif.csv", col_types = cols())
```

Shuffled network motifs. 13 communities x 7 motifs x 1000 bootstraps = 91000 rows

```{r}
read_csv("~/Dropbox/lab/emergent-coexistence/data/output/communities_motif_randomized.csv", col_types = cols())
```

## Competitive hierarchy

```{r}
if (run_scripts) source("script/03B-network_measure-02-competitive_hierarchy.R")
```

See Higgins2017 for the hierarchy score calculation. Briefly, the hierarchy score is based on the relative abundance of each pair and it ranges from 0.5 (pure non-hierarchy with all pairs coexist at 50%:50%) to 1 (pure hierarchy with all pairs being exclusion and forming a transitive network).

The hierarchy score of each communities is compared to a set of 1000 randomized networks which keeps the same relative abundances of each pairs but shuffled. 


From Higgins2017, the competitive score $s_i$ of each strain $i$ was defined as its mean fraction $f_{ij}$ after co-culture with each of the $n-1$ competitor strains:

$$s_i=(\sum_{i\neq j}f_{ij})/(n-1)$$

The hierarchy score $h$ for an n-member netowkr is calculated as:

$$h = \sum_{s_i>s_j}f_{ij}$$

```{r}
read_csv("~/Dropbox/lab/emergent-coexistence/data/output/communities_hierarchy.csv", col_types = cols())
```




## Diagonal analysis

```{r}
# It takes 1 minutes to run this script for 1000 bootstraps
if (run_scripts) source("script/03B-network_measure-03-distance_to_diagonal.R")
```

For record, it took 671 seconds ~= 11 minutes to compute the diagonal measures for 13 communities X 1000 randomization, merge them into one single data frame.

`data/output/communities_diag`

`data/output/communities_diag_randomized`

For a network matrix $m_{ij}$, the fraction of coexistence as a function of distance to diagonal is calculated as the

$$\frac{}{\lvert i-j \lvert}$$
 
`communities_diag_randomized` has four columns

`Randomization`: the number of randomization 

```{r}
read_csv("~/Dropbox/lab/emergent-coexistence/data/output/communities_diag.csv", col_types = cols())
```

```{r}
read_csv("~/Dropbox/lab/emergent-coexistence/data/output/communities_diag_randomized.csv", col_types = cols())
```


## Node degree in coexistence-only network

```{r}
# It takes 3 minutes to finish it
if (run_scripts) source("script/03B-network_measure-04-node_degree.R")
```


```{r}
read_csv("~/Dropbox/lab/emergent-coexistence/data/output/communities_degree.csv", col_types = cols())
```

```{r}
read_csv("~/Dropbox/lab/emergent-coexistence/data/output/communities_degree_randomized.csv", col_types = cols())
```




## Network component of coexistence-only networks

```{r}
if (run_scripts) source("script/03B-network_measure-05-component_count.R")
```


```{r}
read_csv("~/Dropbox/lab/emergent-coexistence/data/output/networks_component.csv", col_types = cols())
```


```{r}
read_csv("~/Dropbox/lab/emergent-coexistence/data/output/networks_component_randomized.csv", col_types = cols())
```
