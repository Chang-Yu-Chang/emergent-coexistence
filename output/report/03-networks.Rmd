---
title: "Analysis on the empirical invasion networks"
author: "Chang-Yu Chang"
date: "`r Sys.Date()`"
output:
  html_notebook:  
    toc: yes
    number_sections: no
---

```{r setup, include = F}
knitr::opts_chunk$set(cache = FALSE, echo = FALSE)

library(tidyverse)
library(data.table)
library(cowplot)
library(igraph)
library(tidygraph)
library(ggraph)
source(here::here("plotting_scripts/network_functions.R"))
run_scripts <- F
communities <- read_csv(here::here("data/output/communities.csv"))
```

# Introduction

- The R scripts (sourced in this Rmd) can be run externally to Rstudio.
- The R scripts are only for saving R functions, processing raw and temporary data.
- All visualization codes are in this Rmd file.

# 03A-make_network

- Make community network from `data/output/pairs.csv`.

- Plot networks and matrices

## Make network

```{r}
if (run_scripts) source("script/03A-make_network-01-make_pairwise_network.R")
```


```{r fig.width=10, fig.height=8}
load(here::here("data/output/network_community.Rdata"))
p_net_list <- lapply(net_list, plot_competitive_network) %>% suppressWarnings()
plot_grid(plotlist = p_net_list, ncol = 4)
```


## Randomize networks

```{r}
if (run_scripts) source("script/03A-make_network-03-randomize_network.R")
```

For record, it took 2603 seconds ~= 40 mins to generate 10000 randomized networks for all 13 communities. 

It took ~50 seconds to randomize 1000 times for each of the communities. So total of 641 seconds needed.

The randomized networks are saved in `data/output/network_randomized.Rdata` which contains a two-layer R list `net_randomized_list` in which the first layer has the 13 communities and the second layer has 1000 randomized networks.

Example of randomized network matrix
```{r fig.width = 3, fig.height = 3}
load(here::here("data/output/network_randomized.Rdata"))
net_randomized_list$C11R2[[1]] %>% plot_adjacent_matrix()
```


# 03B-network_measure

## Detect motifs in networks

```{r eval = F}
# This may take ~5 minutes for 10000 bootstrapping
if (run_scripts) source("script/03B-network_measure-01-detect_motif.R")
```

- `networks_motif`: data.frame
- `networks_motif_randomized`: data.frame for all randomized networks motif counts

Empirical network motifs. 13 communities x 7 motifs = 91 rows

```{r}
networks_motif <- read_csv(here::here("data/output/networks_motif.csv"))
networks_motif
```

Shuffled network motifs. 13 communities x 7 motifs x 1000 bootstraps = 91000 rows

```{r}
networks_motif_randomized <- read_csv(here::here("data/output/networks_motif_randomized.csv"))
networks_motif_randomized
```

## Competitive hierarchy

```{r}
if (run_scripts) source("script/03B-network_measure-02-competitive_hierarchy.R")
```

See Higgins2017 for the hierarchy score calculation. Briefly, the hierarchy score is based on the relative abundance of each pair and it ranges from 0.5 (pure non-hierarchy with all pairs coexist at 50%:50%) to 1 (pure hierarchy with all pairs being exclusion and forming a transitive network).

The hierarchy score of each communities is compared to a set of 1000 randomized networks which keeps the same relative abundances of each pairs but shuffled. 


## Diagonal analysis

```{r}
# It takes 26 minutes to run this script for 10000 bootstraps
if (run_scripts) source("script/03B-network_measure-03-distance_to_diagonal.R")
```

For record, it took 1655 seconds ~= 26 minutes to compute the diagonal measures for 13 communities X 10000 randomization, merge them into one single data frame.

`data/output/networks_diag`

`data/output/networks_diag_randomized`

For a network matrix $m_{ij}$, the fraction of coexistence as a fucntion of distance to diagonal is calculated as the

$$\frac{}{\lvert i-j \lvert}$$
 
`networks_diag_randomized` has four columns

`Randomization`: the number of randomization 

```{r}
networks_diag <- read_csv(here::here("data/output/networks_diag.csv"))
networks_diag_randomized
```

```{r}
networks_diag_randomized <- read_csv(here::here("data/output/networks_diag_randomized.csv"))
networks_diag_randomized
```




# Summary


- `isolates`: 68 isolates
- `pairs`: 186 pairs
- `communities`: metadata of 13 communities
- `network_community.Rdata` saves one R lists. `net_list`  has 13 `tbl_graph` objects. that describes the competitive networks of my communities, where `p_net_list` has 13 pictures.

```{r echo = T}
isolates <- read_csv(here::here("data/output/isolates.csv"))
pairs <- read_csv(here::here("data/output/pairs.csv"))
communities <- read_csv(here::here("data/output/communities.csv"))
load(here::here("data/output/network_community.Rdata"))
```


## Convert the graph file into txt 

So that the graph is readable in python

```{r}
load(here::here("data/output/network_community.Rdata"))
load(here::here("data/output/motif_list.Rdata"))

# Only use those that are 
library(igraph)
for (i in 1:length(net_list)) {
    write_graph(net_list[[i]], here::here(paste0("data/temp/networks/", names(net_list)[i], ".txt")))
}
for (i in 1:length(motif_list)) {
    write_graph(motif_list[[i]], here::here(paste0("data/temp/networks/motif", i, ".txt")))
}


write_graph(net_list[[i]], here::here(paste0("data/temp/networks/", names(net_list)[i], ".txt")))
write_graph(motif_list[[i]], here::here(paste0("data/temp/networks/", names(net_list)[i], ".txt")))

```



## Plot network in matrix

Upper half matrices

```{r fig.width=5, fig.height=8}
p_net_matrix_list <- lapply(net_list, function(x) plot_adjacent_matrix(x)) %>% setNames(communities$Community)
p_net_matrix_list <- p_net_matrix_list[order(communities$CommunitySize, decreasing = T)]
plot_grid(plotlist = p_net_matrix_list, labels = LETTERS[2:14], ncol = 3, hjust = 1)
```

## Plot network in graph

There are some functions to play with 
```{r, fig.width=5, fig.height=8}
p_net_list <- p_net_list[order(communities$CommunitySize,decreasing = T)]
plot_grid(plotlist = p_net_list, labels = LETTERS[2:14], ncol = 3, hjust = -1)
```

## Combine matrix and network plot

```{r}
p_list <- rep(list(NA), length(net_list))
names(p_list) <- communities$Community

for (i in 1:length(net_list)) {
  p_list[[i]] <- ggdraw(p_net_matrix_list[[i]]) +
    draw_plot(plot = p_net_list[[i]], x = 0, y = 0, width = 0.45, height = 0.5)
}
```


```{r, fig.width=10, fig.height=16}
p <- plot_grid(plotlist = p_list, ncol = 3, hjust = -1, vjust = 1)
ggsave("figure/03-networks.png", width = 20, height = 32)
p
```



