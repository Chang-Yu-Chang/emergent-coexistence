---
title: "Random network CASEU"
author: "Chang-Yu Chang"
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: yes
    number_sections: no
linkcolor: red
fontsize: 12pt
urlcolor: blue
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  cache = TRUE, 
  echo = FALSE,
	fig.align = "center",
	fig.height = 4,
	fig.width = 6)
library(tidyverse)
library(data.table)
library(invnet)
library(cowplot)
root <- rprojroot::is_r_package # Package root
source(root$find_file("misc/utils.R"))
write_all_csv <- T
write_all_pdf <- T

# 
communities <- fread(root$find_file("data/temp/communities.csv"))
communities_name <- communities$Community
communities_size <- communities$CommunitySize
isolates_ID_match <- fread(root$find_file("data/temp/isolates_ID_match.csv"))
isolates <- fread(root$find_file("data/output/isolates.csv"))
jean_isolates_RDP <- fread(root$find_file("data/temp/jean_isolates_RDP.csv"))
isolates_assembly <- fread(root$find_file("data/temp/isolates_assembly.csv"))
```

This Rmd processes the raw data from CASEU and return table of isolate frequencies in csv file form.


# Random network, CASEU batch 1

- Genewiz submisstion code: Caseu_RN_1
- Plate layout: T3 C P2
- Description: samples 3, 4, 5, 12, 13, 27, 29, 33, 73, 85, 86, 91, and 94 (order by column in the plate layout) arrived Genewiz dry, so they are not processed.

```{r eval = F}
source("script/05C-random_network_CASEU-01-batch1.R")
```


```{r}
if (write_all_csv) fwrite(CASEU_RN1, file = root$find_file("data/temp/CASEU_RN1.csv"))
```

```{r}
p_temp <- CASEU_RN1 %>%
  mutate(T0 = Isolate1Freq, T3 = Isolate1FreqPredicted, InitialFrequency = factor(T0)) %>% 
  select(Community, Isolate1, Isolate2, InitialFrequency, T0, T3) %>%
  pivot_longer(cols = c(T0, T3), names_to = "Transfer", values_to = "Isolate1Freq") %>%
  mutate(Transfer = ordered(Transfer, levels = c("T0", "T3"))) %>%
  ggplot(aes(x = Transfer, y = Isolate1Freq, color = InitialFrequency, group = InitialFrequency)) +
  geom_point() + geom_line() +
  facet_grid(Isolate1 ~ Isolate2) + 
  scale_y_continuous(limits = c(0,1)) +
  theme_bw() +
  ggtitle("Random network 1") +
  labs(x = "transfer", y = "isolate1 frequency")

p_temp
```

```{r}
pdf(root$find_file("output/report/figure/05C-random_netowkr_CASEU-caseu_RN1.pdf"), width = 12, height = 10); p_temp; invisible(dev.off())
```


# Random network, CASEU batch2

- Genewiz submisstion code: Caseu_RN_2
- Plate layout: T3 C P2
- Description: this plate layout contains the isolates for all 4 random assembled communities 

```{r}
source("script/05C-random_network_CASEU-02-batch2.R")
```


```{r}
if (write_all_csv) fwrite(CASEU_RN2, file = root$find_file("data/temp/CASEU_RN2.csv"))
```


```{r}
CASEU_RN2 <- fread(root$find_file("data/temp/CASEU_RN2.csv"))
CASEU_RN2
```


```{r}
p_temp <- CASEU_RN2 %>%
  mutate(T0 = Isolate1Freq, T3 = Isolate1FreqPredicted, InitialFrequency = factor(T0)) %>% 
  select(Community, Isolate1, Isolate2, InitialFrequency, T0, T3) %>%
  pivot_longer(cols = c(T0, T3), names_to = "Transfer", values_to = "Isolate1Freq") %>%
  mutate(Transfer = ordered(Transfer, levels = c("T0", "T3"))) %>%
  ggplot(aes(x = Transfer, y = Isolate1Freq, color = InitialFrequency, group = InitialFrequency)) +
  geom_point() + geom_line() +
  facet_grid(Isolate1 ~ Isolate2) + 
  scale_y_continuous(limits = c(0,1)) +
  theme_bw() +
  ggtitle("Random network 1") +
  labs(x = "transfer", y = "isolate1 frequency")

p_temp
```


# Random network, CASEU batch3

- Genewiz submisstion code: Caseu_RN_3
- Plate layout: 
    - P1 (T0 C P2), tracking number 30-333649143
    - P2 (T0 AD P2), tracking number 30-333649365
    - P3 (T3 AD P2), tracking number 30-333649517
- Description: AD plates have the isolates assmebled from the self-assembled communities but different

```{r eval = F}
source("script/05C-random_network_CASEU-03-batch3.R")
```


```{r}
if (write_all_csv) fwrite(CASEU_RN3, root$find_file("data/temp/CASEU_RN3.csv"))
CASEU_RN3
```

```{r}
CASEU_RN3 <- fread(root$find_file("data/temp/CASEU_RN3.csv"))
"
Use T0 OD frequencies
"
temp <- CASEU_RN3 %>% 
  filter(Community == "AcrAss1") %>%
  mutate(InitialFrequency = factor(Isolate1Freq), Time = ordered(Time, c("T0", "T3")))
#  select(-Sample, -Mixture, -RSquare, -Isolate2FreqPredicted) %>%

temp$Isolate1FreqPredicted[temp$Time == "T0"] <- temp$Isolate1Freq[temp$Time == "T0"]
  
temp %>%
  select(Time, Community, Isolate1, Isolate2, InitialFrequency, Isolate1FreqPredicted) %>%
  arrange(Isolate1, Isolate2, InitialFrequency, Time) %>%
  ggplot(aes(x = Time, y = Isolate1FreqPredicted, color = InitialFrequency, group = InitialFrequency)) +
  geom_point() + geom_line() +
  facet_grid(Isolate1 ~ Isolate2) + 
  scale_y_continuous(limits = c(0,1)) +
  theme_bw() +
  ggtitle("AcrAss1") +
  labs(x = "transfer", y = "isolate1 frequency")
```


```{r}
"
Use CASEU predicted frequencies
"
CASEU_RN3 %>% 
  filter(Community == "AcrAss1") %>%
  mutate(InitialFrequency = factor(Isolate1Freq), Time = ordered(Time, c("T0", "T3"))) %>%
  select(-Sample, -Mixture, -RSquare, -Isolate2FreqPredicted) %>%
  select(Time, Community, Isolate1, Isolate2, InitialFrequency, Isolate1FreqPredicted) %>%
  arrange(Isolate1, Isolate2, InitialFrequency, Time) %>%
  ggplot(aes(x = Time, y = Isolate1FreqPredicted, color = InitialFrequency, group = InitialFrequency)) +
  geom_point() + geom_line() +
  facet_grid(Isolate1 ~ Isolate2) + 
  scale_y_continuous(limits = c(0,1)) +
  theme_bw() +
  ggtitle("AcrAss1") +
  labs(x = "transfer", y = "isolate1 frequency")
```


```{r}
temp %>% 
  filter(Time == "T3") %>%
  select(Time, Community, Isolate1, Isolate2, InitialFrequency, Isolate1FreqPredicted)
```


























