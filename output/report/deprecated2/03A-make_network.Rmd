---
title: "Network motifs in communities"
author: "Chang-Yu Chang"
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: yes
    number_sections: no
linkcolor: red
fontsize: 12pt
urlcolor: blue
---

```{r setup, include = FALSE}
# Knitr options
knitr::opts_chunk$set(
  cache = TRUE,
  echo = FALSE,
  fig.align = "center",
  fig.height = 4,
  fig.width = 6)

# Packages
library(tidyverse)
library(data.table)
library(invnet)
library(igraph)
library(tidygraph)
library(ggraph)
library(cowplot)

# Local directory and functions
root <- rprojroot::is_r_package # Package root
source(root$find_file("misc/utils.R"))
source(root$find_file("misc/network_functions.R"))
write_all_csv <- TRUE
write_all_pdf <- TRUE

# Data
isolates <- fread(root$find_file("data/output/isolates.csv"))
pairs <- fread(root$find_file("data/output/pairs.csv"))
communities <- fread(root$find_file("data/temp/communities.csv"))
communities_name <- communities$Community
communities_size <- communities$CommunitySize
communities_name_pool <- c(paste0("C", 1:12, "Rpool"), paste0("C", rep(1:12, each = 8), "R", rep(1:8, 12)))
families_name <- c("Aeromonadaceae", "Alcaligenaceae", "Bradyrhizobiaceae", "Brucellaceae", "Burkholderiaceae", "Caulobacteraceae", "Cellulomonadaceae", "Chitinophagaceae", "Chthoniobacteraceae", "Comamonadaceae", "Cryomorphaceae", "Enterobacteriaceae", "Enterococcaceae", "Flavobacteriaceae", "Hyphomicrobiaceae", "Listeriaceae", "Microbacteriaceae", "Moraxellaceae", "Nocardiaceae", "Obscuribacterales.17", "Oxalobacteraceae", "Paenibacillaceae", "Phyllobacteriaceae", "Porphyromonadaceae", "Pseudomonadaceae", "Rhizobiaceae", "Sanguibacteraceae", "Sphingobacteriaceae", "Sphingomonadaceae", "Xanthomonadaceae")
```


# Goal {-}

- Make community network from `data/output/pairs.csv`.

- Plot networks and matrices

For `R >= 3.5.0`, use `BiocManager::install()` instead of `biocLite()` to install Bioconductor-mentained packages. 

```{r eval = F, echo = T}
#install.packages("PlayerRatings") # Calculate the rank
install.packages("igraph") # Network analysis
```


```{r echo = T, message = F}
library(igraph)
library(tidygraph)
library(ggraph)
```


# Make network

```{r}
source("script/03A-make_network-01-make_pairwise_network.R")
```

Plot network

```{r eval = F}
pdf(root$find_file("output/figure/communities_network.pdf"))
for (i in 1:length(net_list)) network_plot(net_list[[i]], main = names(net_list)[i])
invisible(dev.off())
```

Network in circle

```{r}
for (i in 1:length(net_list)) network_plot(net_list[[i]], main = names(net_list)[i])
```


```{r}
p_net_tbl_list <- rep(list(NA), length(net_tbl_list))
for (i in 1:length(net_tbl_list)) p_net_tbl_list[[i]] <- network_tbl_plot(net_tbl_list[[i]], main = names(net_tbl_list)[i])
```

```{r fig.width=10, fig.height=8}
plot_grid(plotlist = p_net_tbl_list, ncol = 4)
```


```{r}
if (write_all_csv) save(net_list, net_tbl_list, p_net_tbl_list, file = root$find_file("data/temp/network_community.Rdata"))
```


# Pairwise matrice

```{r}
source("script/03A-make_network-02-pairwise_matrix.R")
```


```{r}
if (write_all_csv) fwrite(isolates_tournament, file = root$find_file("data/temp/isolates_tournament.csv"))
```


Tournament ranks of each isolate. Note that I consider neturality and bistability as draw in the tournament.

- `Score`: the competitive scores of isolate. This score is computed by the formula: number of wins - number of loses + 0 * number of draws. 

- `Game`: number of pairwise competition the isolate has played. The number of games an isolate plated within a community should be community size minus one. 

- `Rank`: the ranks based on `Score`. The ranks range from 1 to the focal community size. Isolates with the same scores in a community are given the same rank.

- `PlotRank`: continuous rank for plotting convenience.

```{r}
isolates_tournament
```


Plot the communities' pairwise matrix, whose axis are ordered by competitive ranks

```{r}
pdf(root$find_file("output/figure/communities_pairwise_matrix.pdf"), width = 12, height = 8); for (i in 1:length(net_list)) print(p_net_matrix_plot_list[[i]]); invisible(dev.off())
```


Plot the communities' pairwise matrix, whose axis are ordered by isolates' traits

```{r}
# Yield in glucose
pdf(root$find_file("output/figure/communities_pairwise_matrix_OD620.pdf"), width = 12, height = 8); for (i in 1:length(net_list)) print(p_matrix_plot_list_OD620[[i]]); invisible(dev.off())

# Maximal growth rate in glucose
pdf(root$find_file("output/figure/communities_pairwise_matrix_growth_rate.pdf"), width = 12, height = 8); for (i in 1:length(net_list)) print(p_matrix_plot_list_growth_rate[[i]]); invisible(dev.off())

# Lag time in glucose
pdf(root$find_file("output/figure/communities_pairwise_matrix_lag.pdf"), width = 12, height = 8); for (i in 1:length(net_list)) print(p_matrix_plot_list_lag[[i]]); invisible(dev.off())
```

# Randomize networks

```{r}
source("script/03A-make_network-03-randomize_network.R")
```

The R list for randomzied networks are saved within the R script. For record, it took 2603 seconds ~= 40 mins to generate 10000 randomized networks for each of 13 communities.

The randomized networks are saved in `data/temp/network_random_list.Rdata` which contains a two-layer R list `net_random_list` in which the first layer has the 13 communities and the second layer has 10000 randomized networks.


Example of randomized network matrix

```{r fig.width = 3, fig.height = 3}
net_random_list$C11R2[[1]] %>% adj_matrix_plot(isolate_label = NULL)
```

