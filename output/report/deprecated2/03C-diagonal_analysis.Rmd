---
title: "Diagonal analysis of competitive network"
author: "Chang-Yu Chang"
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: yes
    number_sections: no
linkcolor: red
fontsize: 12pt
urlcolor: blue
---

```{r setup, include = FALSE}
# Knitr options
knitr::opts_chunk$set(
  cache = TRUE,
  echo = FALSE,
  fig.align = "center",
  fig.height = 4,
  fig.width = 6)

# Packages
library(tidyverse)
library(data.table)
library(invnet)
library(igraph)

# Local directory and functions
root <- rprojroot::is_r_package # Package root
source(root$find_file("misc/utils.R"))
source(root$find_file("misc/network_functions.R"))
write_all_csv <- TRUE
write_all_pdf <- TRUE

# Data
isolates <- fread(root$find_file("data/output/isolates.csv"))
pairs <- fread(root$find_file("data/output/pairs.csv"))
communities <- fread(root$find_file("data/temp/communities.csv"))
communities_name <- communities$Community
communities_size <- communities$CommunitySize
communities_name_pool <- c(paste0("C", 1:12, "Rpool"), paste0("C", rep(1:12, each = 8), "R", rep(1:8, 12)))
families_name <- c("Aeromonadaceae", "Alcaligenaceae", "Bradyrhizobiaceae", "Brucellaceae", "Burkholderiaceae", "Caulobacteraceae", "Cellulomonadaceae", "Chitinophagaceae", "Chthoniobacteraceae", "Comamonadaceae", "Cryomorphaceae", "Enterobacteriaceae", "Enterococcaceae", "Flavobacteriaceae", "Hyphomicrobiaceae", "Listeriaceae", "Microbacteriaceae", "Moraxellaceae", "Nocardiaceae", "Obscuribacterales.17", "Oxalobacteraceae", "Paenibacillaceae", "Phyllobacteriaceae", "Porphyromonadaceae", "Pseudomonadaceae", "Rhizobiaceae", "Sanguibacteraceae", "Sphingobacteriaceae", "Sphingomonadaceae", "Xanthomonadaceae")
```



# Competitive hierarchy 

```{r}
source("script/03C-diagnonal_analysis-01-competitive_hierarchy.R")
```

The competitive scores for all pairs are converted into a pairwise competitive matrix, with a value of "1" representing a win and a value of "0" representing a loss. Pairings that resulted on a draw were assingned a value of 0.5, representing coexistence.

The competitive intransitivity is determined as follow

$$\frac{\sum I{a_{ij}<a_{ji}}}{n(n-1)/2}$$

# Diagonal analysis

```{r}
# It takes 26 minutes to run this script
source("script/03C-diagnonal_analysis-02-distance_to_diagonal.R")
```

For record, it took 1655 seconds ~= 26 minutes to compute the diagonal measures for 13 communities X 10000 randomization, merge them into one single data frame.

`data/temp/networks_diag`

`data/temp/networks_diag_rand`

For a network matrix $m_{ij}$, the fraction of coexistence as a fucntion of distance to diagonal is calculated as the

$$\frac{}{\lvert i-j \lvert}$$
 
`networks_diag_rand` has four columns:

`Randomization`: the number of randomization 

```{r}
networks_diag_rand
```


# Plot the diagonal analysis

```{r}
source("script/03C-diagnonal_analysis-03-plot_diagonal_analysis.R")
```


```{r fig.width = 5, fig.height = 5}
p_networks_diag
pdf(root$find_file("output/figure/networks_diagonal.pdf"), width = 10, height = 10); p_networks_diag; invisible(dev.off())
```



```{r fig.width = 9, fig.height = 3}

p_networks_diag_pool <- cowplot::plot_grid(p_networks_diag_pool1, p_networks_diag_pool2, p_networks_diag_pool3, ncol = 3, align = "h")

pdf(root$find_file("output/figure/networks_diagonal_pool.pdf"), width = 10, height = 3); p_networks_diag_pool; invisible(dev.off())

```






