---
title: "Analysis on competitive network"
author: "Chang-Yu Chang"
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: yes
    number_sections: no
linkcolor: red
fontsize: 12pt
urlcolor: blue
---

```{r setup, include = FALSE}
# Knitr options
knitr::opts_chunk$set(
  cache = FALSE,
  echo = FALSE,
  fig.align = "center",
  fig.height = 4,
  fig.width = 6
)

# Local directory and functions
root <- rprojroot::is_r_package # Package root
source(root$find_file("misc/utils.R"))
source(root$find_file("misc/network_functions.R"))
write_all_csv <- TRUE
write_all_pdf <- TRUE
```

# Prerequisite 

```{r echo = T, message = F}
library(tidyverse)
library(data.table)
library(cowplot)
library(invnet) # Self-use package for this project
library(igraph)
library(tidygraph)
library(ggraph)
```


# Read data

```{r echo = T}
isolates <- fread(root$find_file("data/output/isolates.csv"))
pairs <- fread(root$find_file("data/output/pairs.csv"))
communities <- fread(root$find_file("data/temp/communities.csv"))
load(root$find_file("data/output/vectors_for_analysis.Rdata"))
load(root$find_file("data/temp/network_community.Rdata"))
```

- `isolates`: information about 68 isolates

- `communities`: infromation about 13 communities

- `vectors_for_analysis.Rdata` keeps the common used vectors in this project, for example, `communities_name` is a vector of 13 community names in order, `communities_size` is a vector of 13 community sizes, and `communities_name_pool` is the ordered overall community names from emergent simplicity paper.

- `network_community.Rdata` saves two R lists. `net_list`  has 13 `igraph` objects that describes the competitive networks of my communities, where `net_tbl_list` has 13 `tbl_graph` objects.


# Visualize competitive networks

## Plot network in matrix

Upper half matrices

```{r}
# Make figure list
p_net_matrix_list <- rep(list(NA), length(net_list))
names(p_net_matrix_list) <- communities_name
for (i in 1:length(net_list)) p_net_matrix_list[[i]] <- adj_matrix_plot(net_list[[i]], show_axis_label = F, show_title_legend = F, show_half_matrix = T, standardize_tile_size = T)

# Sort matrices by community sizes 
p_net_matrix_list <- p_net_matrix_list[order(communities_size,decreasing = T)]
```

```{r fig.width=5, fig.height=8}
plot_grid(plotlist = p_net_matrix_list, labels = LETTERS[2:14], ncol = 3, hjust = 1)
```

## Plot network in graph

There are some functions to play with 

`geom_edge_link`, `geom_node_point`, `geom_node_text`, `geom_edge_arc`

```{r}
p_net_tbl_list <- rep(list(NA), length(net_tbl_list))
names(p_net_tbl_list) <- communities_name
for (i in 1:length(net_tbl_list)) p_net_tbl_list[[i]] <- network_tbl_plot(net_tbl_list[[i]], show_title_legend = F, show_node_label = F)

# Sort networks by community sizes 
p_net_tbl_list <- p_net_tbl_list[order(communities_size,decreasing = T)]
```

```{r, fig.width=5, fig.height=8}
plot_grid(plotlist = p_net_tbl_list, labels = LETTERS[2:14], ncol = 3, hjust = -1)
```

## Combine matrix and network plot

```{r}
p_net_list <- rep(list(NA), length(net_tbl_list))
names(p_net_list) <- communities_name

for (i in 1:length(net_tbl_list)) {
  p_net_list[[i]] <- ggdraw(p_net_matrix_list[[i]]) +
    draw_plot(plot = p_net_tbl_list[[i]], x = 0, y = 0, width = 0.45, height = 0.5)
}

```


```{r, fig.width=10, fig.height=16}
p <- plot_grid(plotlist = p_net_list, labels = LETTERS[2:14], ncol = 3, hjust = -1, vjust = 1)
pdf(root$find_file("output/figure/communities_network_matrix.pdf"), width = 20, height = 32); p; invisible(dev.off())
p
```

























