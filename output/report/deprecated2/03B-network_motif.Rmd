---
title: "Network motifs in communities"
author: "Chang-Yu Chang"
date: "`r Sys.Date()`"
output:
  html_notebook:
    number_sections: no
    toc: yes
linkcolor: red
fontsize: 12pt
urlcolor: blue
---

```{r setup, include = FALSE}
# Knitr options
knitr::opts_chunk$set(
  cache = TRUE,
  echo = FALSE,
  fig.align = "center",
  fig.height = 4,
  fig.width = 6)

# Packages
library(tidyverse)
library(data.table)
library(invnet)
library(igraph)
library(tidygraph)
library(ggraph)

# Local directory and functions
root <- rprojroot::is_r_package # Package root
source(root$find_file("misc/utils.R"))
source(root$find_file("misc/network_functions.R"))
write_all_csv <- TRUE
write_all_pdf <- TRUE

# Data
isolates <- fread(root$find_file("data/output/isolates.csv"))
pairs <- fread(root$find_file("data/output/pairs.csv"))
communities <- fread(root$find_file("data/temp/communities.csv"))
communities_name <- communities$Community
communities_size <- communities$CommunitySize
communities_name_pool <- c(paste0("C", 1:12, "Rpool"), paste0("C", rep(1:12, each = 8), "R", rep(1:8, 12)))
families_name <- c("Aeromonadaceae", "Alcaligenaceae", "Bradyrhizobiaceae", "Brucellaceae", "Burkholderiaceae", "Caulobacteraceae", "Cellulomonadaceae", "Chitinophagaceae", "Chthoniobacteraceae", "Comamonadaceae", "Cryomorphaceae", "Enterobacteriaceae", "Enterococcaceae", "Flavobacteriaceae", "Hyphomicrobiaceae", "Listeriaceae", "Microbacteriaceae", "Moraxellaceae", "Nocardiaceae", "Obscuribacterales.17", "Oxalobacteraceae", "Paenibacillaceae", "Phyllobacteriaceae", "Porphyromonadaceae", "Pseudomonadaceae", "Rhizobiaceae", "Sanguibacteraceae", "Sphingobacteriaceae", "Sphingomonadaceae", "Xanthomonadaceae")
```



# Detect motifs in networks


```{r eval = F}
# This may take ~5 minutes for 1000 boostrapping
source("script/03B-invasion_network-01-detect_motif.R")
```

In this script, three objects are saved in a Rdata `data/temp/networks_motif_random.Rdata`

- `networks_motif`: dataframe
- `networks_motif_rand`: dataframe for all randomized networks motif counts
- `networks_motif_rand_percentile`: 5th and 95th percentile of motif counts


```{r}
# Save the result
if (write_all_csv) {
  fwrite(networks_motif, file = root$find_file("data/temp/networks_motif.csv"))
  fwrite(networks_motif_rand, file = root$find_file("data/temp/networks_motif_rand.csv"))
  fwrite(networks_motif_rand_percentile, root$find_file("data/temp/networks_motif_rand_percentile.csv"))
}

```

# Types of motifs in a pairwise competitive network

```{r}
source("script/03B-invasion_network-02-plot_motif.R")
```


```{r fig.width = 8, fig.height = 1.5}
p_motif_example
```


Detect motifs in randomized networks

```{r fig.width=5, fig.height=5}
p_motif_random
pdf(root$find_file("output/figure/motif_randomization.pdf"), width = 10, height = 10); p_motif_random; invisible(dev.off())
```

Plot the histogram of randomized network motifs 

```{r fig.width = 10, fig.height = 15}
pdf(root$find_file("output/figure/motif_histogram.pdf"), width = 20, height = 30); p_motif_rand_histo; invisible(dev.off())
```



# Detect motif in three community pools

```{r}
source("script/03B-invasion_network-03-motif_in_three_pools.R")
```


1. All 13 communities pooled together

2. Only large communities

3. Only small communities

```{r message = F, fig.width=8, fig.height=5}
for (i in 1:3) print(p_motif_pool_list[[i]])
```


```{r}
if (write_all_pdf) pdf(root$find_file("output/figure/motif_histogram_pools.pdf"), width = 16, height = 12); for (i in 1:3) print(p_motif_pool_list[[i]]); invisible(dev.off())
```

