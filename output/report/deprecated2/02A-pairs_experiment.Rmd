---
title: "Pairwise competition experiment "
author: "Chang-Yu Chang"
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: yes
    number_sections: no
linkcolor: red
fontsize: 12pt
urlcolor: blue

---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  cache = TRUE, 
  echo = FALSE,
	fig.align = "center",
	fig.height = 4,
	fig.width = 6)
library(tidyverse)
library(data.table)
library(invnet)
root <- rprojroot::is_r_package # Package root
source(root$find_file("misc/utils.R")) # Small self-utility functions
source(root$find_file("misc/network_functions.R")) # Functions for network analysis
write_all_csv <- TRUE
write_all_pdf <- TRUE
communities <- fread(root$find_file("data/temp/communities.csv"))
communities_name <- communities$Community
communities_size <- communities$CommunitySize
isolates_ID_match <- fread(root$find_file("data/temp/isolates_ID_match.csv"))
```

# Goal {-}

- Experiment related scripts

- Read pairwise competition outcomes that are determined by colony counts on plates. 

- Filter out ambiguous pairs and later fill in the data hole by CASEU results. 

- Map pairs and isolates to the 96-well plate layout


# Read the pairwise competitive outcomes determined by colony counting on TSA

Generate table for manual key-in

```{r eval = F}
source("script/02A-pairs_experiment-01-pairwise_manual_key_in.R")
```

Then I manually checked the scanned plate images of competitive pairs. The plate images are saved in folder `plate_scan/high_order_plate_scan/` and divided according the experimental batches.

Batch | Community
------|-----------
B2    | 2.6, 2.8, 7.1, 8.4, 10.2, 11.1
C     | 11.1 isolate 1
C2    | 11.2
D     | 1.2, 1.4, 1.6, 1.7, 4.1, 11.5


```{r warning = F}
# Read result colony counts and dilution factor
source("script/02A-pairs_experiment-02-colony_count.R")
```

There are 558 outcomes of pairwise competitions.

```{r}
pairs_competition
```

67 pairs without determined outcomes of pairwise competitions will be determined by using CASEU method

```{r}
pairs_competition %>%
  filter(is.na(ColonyCount))
```

186 pair IDs saved in `pairs_ID`

```{r}
pairs_ID <- pairs_competition %>%
  select(Community, Isolate1, Isolate2) %>%
  distinct()

pairs_ID
```



Write pairwise competition result in `data/temp/pairs_competition.csv` and the pairs basic files in `pairs.csv`

```{r}
if (write_all_csv) {
  fwrite(pairs_competition, file = root$find_file("data/temp/pairs_competition.csv"))
  fwrite(pairs_ID, file = root$find_file("data/temp/pairs_ID.csv"))
}
```



# Ambiguous pairs and isolates on TSA agar plates

```{r warning=F}
source("script/02A-pairs_experiment-03-pairwise_ambiguous.R")
```

There are 67 pair-freqs that I don't know the competitive outcomes by TSA plate counting. The ambiguous pairs will be later examined by using selective media or Sanger sequencing. 

```{r}
pairs_ambiguous
```

28 pairs

```{r}
pairs_ambiguous %>% 
  group_by(Community, Isolate1, Isolate2) %>%
  summarize(Count = n())
```

36 isolates involved in the ambiguous pairs. 

```{r}
isolates_ambiguous
```

Write the ambiguous pair in `data/temp/pairs_ambiguous.csv` and ambiguous isolates  to `data/temp/isolates_ambiguous.csv`

```{r}
if (write_all_csv) {
  fwrite(pairs_ambiguous, file = root$find_file("data/temp/pairs_ambiguous.csv"))
  fwrite(isolates_ambiguous, file = root$find_file("data/temp/isolates_ambiguous.csv"))
}
```


# Map pairs and isolates to the DW96 plate layout

```{r warning = F}
plates_name <- c("plate_B2_933", "plate_B2_444", "plate_C_C11R1", "plate_C2_13A", "plate_C2_13B", "plate_D_75", "plate_D_5543")
source("script/02A-pairs_experiment-04-pairwise_plate_layout.R")
```

Each plate has 96 rows and has the following variables

```{r}
str(plates)
if (write_all_csv) fwrite(plates, root$find_file("data/temp/plates.csv"))
```

Read plate layout by batch

```{r}
easy_plot_plate <- function(plate) {
  mutate(plate,
    TextLabel = ifelse(MixIsolate, paste(Isolate1, Isolate2, sep = "_"), Isolate1),
    FillLabel = paste0(Community, ifelse(MixIsolate, "", "_single"))) %>%
    draw_plate_from_df()
}
for (i in 1:7) assign(paste0("p", i), easy_plot_plate(eval(parse(text = plates_name[i]))))

plot_grid(p1, p2, p3, NULL, p4, p5, p6, p7,
labels = LETTERS[1:7], ncol = 2, nrow = 4)
```

Output pdf `figure/CASEU_pilot2_pairs.pdf` that has the colony morphology ambiguous pairs on DW96 plates layout.

```{r}
pdf("figure/CASEU_pilot2_pairs.pdf", width = 8, height = 6); plot_grid(p1, p1, p2, p3, labels = c("933 P1", "933 P2", "444 P2", "C11R1 P1"), ncol = 2, nrow = 2); dev.off()
```


Plate layout that takes different initial frequencies:

- P1 is 50%:50%.

- P2 and P3 are identical and whose rows are 95% and columns are 5%.

The only exception is plate C11R1 in batch C, which only has one plate.

```{r}
pairs_ambiguous_on_DW96
```

Write the ambiguous pairs location on 96 deep-well plates

```{r}
if (write_all_csv) fwrite(pairs_ambiguous_on_DW96, file = root$find_file("data/temp/pairs_ambiguous_on_DW96.csv"))
```



