---
title: "Determine pairwise interaction"
author: "Chang-Yu Chang"
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: yes
    number_sections: no
linkcolor: red
fontsize: 12pt
urlcolor: blue
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(
  cache = TRUE, 
  echo = FALSE,
	fig.align = "center",
	fig.height = 4,
	fig.width = 6)
library(tidyverse)
library(data.table)
library(invnet)
root <- rprojroot::is_r_package # Package root
source(root$find_file("misc/utils.R"))
write_all_csv <- T
write_all_pdf <- T
communities <- fread(root$find_file("data/temp/communities.csv"))
communities_name <- communities$Community
communities_size <- communities$CommunitySize
isolates_ID_match <- fread(root$find_file("data/temp/isolates_ID_match.csv"))
```


# Combine outcomes of pairwise competition from CFU counts and CASEU

The two Rmd reports process raw data (e.g., CFU counts and CASEU sanger sequences) and generate temporary result csv:

1. `02B-CASEU_sanger_seq.Rmd` reads CASEU raw data and outputs `temp/CASEU_pilot2.csv` and `temp/CASEU_pilot3.csv`. Both files are CASEU predicted T8 frequenciex.

2. `02C-pairs_OD_CFU.Rmd` reads pair_competition and dilution factor data, and it outputs `temp/pairs_CFU_freq_uncertainty.csv`, which has the T0 OD-converted CFU frequencies and T8 CFU frequencies with uncertainties.

**Note that if a pair has both CFU and CASEU result, CASEU will overwrite the CFU result**

```{r}
source("script/02D-determine_pairwise_interaction-01-combine_CFU_CASEU_result.R")
```


The script in this section returns a df `pairs_freq` that has the following variables:

- `Community`

- `Isolate1` and `Isolate2`: indices of isolates. The number of isolate1 is always smaller than isolate2

- `Isolate1InitialODFreq` and `Isolate2InitialODFreq`: 5, 50 or 95. The initial OD frequencies of isolates at T0. This two serve as discrete grouping variables.

- `Time`: T0 or T8.

- `Isolate1MeasuredFreq`: the measured frequency od isolate1 in the pair. 

- `ErrorIsolate1MeasuredFreq`: the uncertainty of `Isolate1MeasuredFreq`.

- `RawDataType`: OD, ODtoCFU, CFU, Sanger (CASEU). The raw data type in which the isolate frequencies were measured.

- `Contamination`: logical. There are contaminations in three pairs at T8 plates.


There is one pair-freq that cannot be specified because of contamination.

```{r}
pairs_freq %>%
  filter(Time == "T8") %>%
  filter(is.na(Isolate1MeasuredFreq))
```


```{r}
if (write_all_csv) fwrite(pairs_freq, file = root$find_file("data/temp/pairs_freq.csv"))
```




# Determine pairwise interactions

```{r warning = F, message = F}
source("script/02D-determine_pairwise_interaction-02-determine_pairwise_interaction.R")
```

Plot frequency changes. Output figure of CFU frequency changes to `output/figure/pairs_freq_change_uncertainty.pdf`

```{r eval = F}
pdf(root$find_file("output/figure/pairs_freq_change_uncertainty.pdf"), height = 10 , width = 10); for (i in 1:length(communities_name)) print(p_pairs_freq_change_list[[i]]); invisible(dev.off())
```

Table of all 27 possible combinations of fitness function and their interaction types 

```{r}
interaction_type
```


Table of interaction types

```{r}
pairs_interaction_fitness %>%
  group_by(InteractionType) %>%
  summarize(Count = n()) 
```

Interaction table

```{r}
pairs_interaction_table
```



Save the results `temp/pairs_interaction.csv` that has only the pairs and interaction types and `pairs_interaction_fitness.csv` that has fitness function

```{r}
if (write_all_csv) {
  fwrite(pairs_interaction, file = root$find_file("data/temp/pairs_interaction.csv"))
  fwrite(interaction_type, file = root$find_file("data/temp/interaction_type.csv"))
  fwrite(pairs_interaction_fitness, file = root$find_file("data/temp/pairs_interaction_fitness.csv"))
  fwrite(pairs_interaction_table, file = root$find_file("data/temp/pairs_interaction_table.csv"))
}
```


## Coexistence pairs

This section is made for Sylvie' experiment

```{r}
source("script/02D-determine_pairwise_interaction-03-coexistence_pairs.R")
```

Pairs that started from 50-50 initial frequency and coexisted at T8

```{r}
fwrite(isolates_coext_50_50, file = root$find_file("data/temp/isolates_coext_50_50.csv"))
fwrite(pairs_coext_50_50, file = root$find_file("data/temp/pairs_coext_50_50.csv"))
```

Pairs that coexisted at T8 from three initial frequencies.

```{r}
fwrite(isolates_coext_all, file = root$find_file("data/temp/isolates_coext_all.csv"))
fwrite(pairs_coext_all, file = root$find_file("data/temp/pairs_coext_all.csv"))
```

# Compute competitive scores for isolates

```{r}
source("script/02D-determine_pairwise_interaction-04-competitive_score.R")
```

```{r}
if (write_all_csv) {
  fwrite(isolates_score, root$find_file("data/temp/isolates_score.csv"))
  fwrite(communities_hierarchy, root$find_file("data/temp/communities_hierarchy.csv"))
}
```


From Higgins2017, the competitive score $s_i$ of each strain $i$ was defined as its mean fraction $f_{ij}$ after co-culture with each of the $n-1$ competitor strains:

$$s_i=(\sum_{i\neq j}f_{ij})/(n-1)$$

The hierarchy score $h$ for an n-member netowkr is calculated as:

$$h = \sum_{s_i>s_j}f_{ij}$$

Competitive score for each isolate

```{r}
isolates_score
```

Degree of community hierarchy

```{r}
communities_hierarchy
```







```{r}
isolates_score %>%
  ggplot() +
  geom_point(aes(x = CompScoreMean, y = Isolate)) +
  geom_segment(aes(x = CompScoreMean - CompScoreSd, xend = CompScoreMean + CompScoreSd, 
    y = Isolate, yend = Isolate)) +
  facet_wrap(Community~.) +
  theme_bw()
```

















