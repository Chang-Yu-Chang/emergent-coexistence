---
title: "Determine pairwise interaction"
author: "Chang-Yu Chang"
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: yes
    number_sections: no
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(cache = TRUE, echo = FALSE)
library(tidyverse)
library(data.table)
```


# Combine outcomes of pairwise competition from CFU counts and CASEU

The two Rmd reports process raw data (e.g., CFU counts and CASEU sanger sequences) and generate temporary result csv:

1. `02B-CASEU_sanger_seq.Rmd` reads CASEU raw data and outputs `temp/CASEU_pilot2.csv` and `temp/CASEU_pilot3.csv`. Both files are CASEU predicted T8 frequenciex.

2. `02C-pairs_OD_CFU.Rmd` reads pair_competition and dilution factor data, and it outputs `temp/pairs_CFU_freq_uncertainty.csv`, which has the T0 OD-converted CFU frequencies and T8 CFU frequencies with uncertainties.

**Note that if a pair has both CFU and CASEU result, CASEU will overwrite the CFU result**

```{r}
source("script/02D-determine_pairwise_interaction-01-combine_CFU_CASEU_result.R")
```


The script in this section returns a df `pairs_freq` that has the following variables:

- `Community`

- `Isolate1` and `Isolate2`: indices of isolates. The number of isolate1 is always smaller than isolate2

- `Isolate1InitialODFreq` and `Isolate2InitialODFreq`: 5, 50 or 95. The initial OD frequencies of isolates at T0. This two serve as discrete grouping variables.

- `Time`: T0 or T8.

- `Isolate1MeasuredFreq`: the measured frequency od isolate1 in the pair. 

- `ErrorIsolate1MeasuredFreq`: the uncertainty of `Isolate1MeasuredFreq`.

- `RawDataType`: OD, ODtoCFU, CFU, Sanger (CASEU). The raw data type in which the isolate frequencies were measured.

- `Contamination`: logical. There are contaminations in three pairs at T8 plates.


There is one pair-freq that cannot be specified because of contamination.

```{r}
pairs_freq %>%
  filter(Time == "T8") %>%
  filter(is.na(Isolate1MeasuredFreq))
```





# Determine pairwise interactions

```{r warning = F, message = F}
source("script/02D-determine_pairwise_interaction-02-determine_pairwise_interaction.R")
```

Plot frequency changes. Output figure of CFU frequency changes to `output/figure/pairs_freq_change_uncertainty.pdf`

```{r eval = F}
pdf(here::here("output/report/figure/02D-pairs_freq_change_uncertainty.pdf"), height = 10 , width = 10); for (i in 1:length(communities_name)) print(p_pairs_freq_change_list[[i]]); invisible(dev.off())
```

Table of all 27 possible combinations of fitness function and their interaction types 

```{r}
interaction_type
```


Table of interaction types

```{r}
pairs_interaction_fitness %>%
  group_by(InteractionType) %>%
  summarize(Count = n()) 
```

Interaction table

```{r}
pairs_interaction_table
```


# Isolate tournament


```{r warning = F, message = F}
source("script/02D-determine_pairwise_interaction-03-isolate_tournament.R")
```



Tournament ranks of each isolate. Note that I consider neturality and bistability as draw in the tournament.

- `Score`: the competitive scores of isolate. This score is computed by the formula: number of wins - number of loses + 0 * number of draws. 

- `Game`: number of pairwise competition the isolate has played. The number of games an isolate plated within a community should be community size minus one. 

- `Rank`: the ranks based on `Score`. The ranks range from 1 to the focal community size. Isolates with the same scores in a community are given the same rank.

- `PlotRank`: continuous rank for plotting convenience.

