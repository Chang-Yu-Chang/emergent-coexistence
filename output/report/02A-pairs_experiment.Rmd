---
title: "Pairwise competition experiment "
author: "Chang-Yu Chang"
date: "`r Sys.Date()`"
output:
  html_notebook:
    toc: yes
    number_sections: no
---

```{r setup, include = FALSE}
knitr::opts_chunk$set(cache = TRUE, echo = FALSE)
library(tidyverse)
library(data.table)
library(cowplot)
communities <- fread(here::here("data/output/communities.csv"))
communities_name <- communities$Community
communities_size <- communities$CommunitySize
isolates_ID_match <- fread(here::here("data/temp/isolates_ID_match.csv"))
```

# Goal {-}

- Experiment related scripts

- Read pairwise competition outcomes that are determined by colony counts on plates. 

- Filter out ambiguous pairs and later fill in the data hole by CASEU results. 

- Map pairs and isolates to the 96-well plate layout


# Read the pairwise competitive outcomes determined by colony counting on TSA

Generate table for manual key-in

```{r eval = F}
source("script/02A-pairs_experiment-01-pairwise_manual_key_in.R")
```

Then I manually checked the scanned plate images of competitive pairs. The plate images are saved in folder `plate_scan/high_order_plate_scan/` and divided according the experimental batches.

Batch | Community
------|-----------
B2    | 2.6, 2.8, 7.1, 8.4, 10.2, 11.1
C     | 11.1 isolate 1
C2    | 11.2
D     | 1.2, 1.4, 1.6, 1.7, 4.1, 11.5


```{r warning = F}
# Read result colony counts and dilution factor
source("script/02A-pairs_experiment-02-colony_count.R")
```

There are 558 outcomes of pairwise competitions.

```{r}
pairs_competition
```

67 pairs without determined outcomes of pairwise competitions will be determined by using CASEU method

```{r}
pairs_competition %>%
  filter(is.na(ColonyCount))
```

186 pair IDs saved in `pairs_ID`

```{r}
pairs_ID
```



# Ambiguous pairs and isolates on TSA agar plates

```{r warning=F}
source("script/02A-pairs_experiment-03-pairwise_ambiguous.R")
```

There are 67 pair-freqs that I don't know the competitive outcomes by TSA plate counting. The ambiguous pairs will be later examined by using selective media or Sanger sequencing. 

```{r}
pairs_ambiguous
```

28 pairs

```{r}
pairs_ambiguous %>% 
  group_by(Community, Isolate1, Isolate2) %>%
  summarize(Count = n())
```

36 isolates involved in the ambiguous pairs. 

```{r}
isolates_ambiguous
```



# Map pairs and isolates to the DW96 plate layout

```{r warning = F}
plates_name <- c("plate_B2_933", "plate_B2_444", "plate_C_C11R1", "plate_C2_13A", "plate_C2_13B", "plate_D_75", "plate_D_5543")
source("script/02A-pairs_experiment-04-pairwise_plate_layout.R")
```

Each plate has 96 rows and has the following variables

```{r}
str(plates)
```

Read plate layout by batch

```{r}
draw_plate_from_df <- function(
  df,
  well_size = 5,
  text_size = 3,
  annotation = TRUE,
  annotate_each_well = TRUE,
  fill_legend = F,
  vjust = 0,
  ...
) {
#  df <-  mutate(plate_B2_933, TextLabel = paste(Isolate1, Isolate2, sep = "_"), FillLabel = paste0(Community, ifelse(MixIsolate, "", "_single")))

  # Check
  stopifnot(
    is.data.frame(df),
    "Well" %in% names(df),
    "TextLabel" %in% names(df) | "FillLabel" %in% names(df)
  )

  # Make plate
  plate <- df %>%
    mutate(
      Row = match(substr(Well, 1, 1), LETTERS[1:8]),
      Col = substr(Well, 2, 3) %>% as.numeric(),
    ) %>%
    filter(!grepl("blank", .$FillLabel)) %>%
    mutate(FillLabel = as.character(FillLabel))

  # Empty well
  empty_well <- data.frame(
    Row = rep(1:8, each = 12),
    Col = rep(1:12, 8)
  )

  # Plot blank plate
  if (all(is.na(plate$FillLabel))) {
    return(
      ggplot() +
        geom_point(data = empty_well, aes(x = Col, y = Row), shape = 1, size = well_size, color = "black", fill = NA) +
        scale_x_continuous(name = "", breaks = 1:12, labels = 1:12, limits = c(1, 12), position = "top") +
        scale_y_reverse(name = "", lim = c(8, 1), breaks = 1:8, labels = LETTERS[1:8]) +
        theme_bw() +
        NULL
    )
  }

  # Plot segments
  g_empty_well <- geom_point(data = empty_well, aes(x = Col, y = Row),
    shape = 1, size = well_size, color = "black", fill = NA)

  g_plate <- geom_point(data = plate, aes(x = Col, y = Row, fill = FillLabel),
    pch = 21, size = well_size)


  # Annotate text for fill
  plate_fill_text <- plate %>%
    group_by(FillLabel) %>%
    summarize(Col = mean(Col), Row = mean(Row)) %>%
    mutate(Row = ifelse((Row %% 1) == 0, Row - vjust, Row))
  #annnotate_well_text <- annotate("text", x = plate$Col, y = plate$Row, label = plate$TextLabel, size = text_size)

  if ("TextLabel" %in% names(df)) {
    g_text_label <- geom_text(data = plate, aes(x = Col, y = Row, label = TextLabel), size = text_size)
  } else g_text_label <- NULL

  if (annotation == T) {
    g_text_fill <- geom_text(data = plate_fill_text, aes(x = Col, y = Row, label = FillLabel))
  } else g_text_fill <- NULL


  # Plot plate
  pp <-
    ggplot() + g_plate + g_empty_well + g_text_label + g_text_fill +
#    geom_text(data = plate_fill_text, aes(x = Col, y = Row, label = FillLabel)) +
    scale_x_continuous(name = "", breaks = 1:12, labels = 1:12, limits = c(1, 12), position = "top") +
    scale_y_reverse(name = "", lim = c(8, 1), breaks = 1:8, labels = LETTERS[1:8]) +
    theme_bw() +
#    theme(legend.position = "top") +
#    guides(fill = F) +
    NULL

  if (fill_legend == T) {
    return(pp+theme(legend.position = "top"))
  } else return(pp + guides(fill=F))

}

easy_plot_plate <- function(plate) {
  mutate(plate,
    TextLabel = ifelse(MixIsolate, paste(Isolate1, Isolate2, sep = "_"), Isolate1),
    FillLabel = paste0(Community, ifelse(MixIsolate, "", "_single"))) %>%
    draw_plate_from_df()
}

```

```{r}
for (i in 1:7) assign(paste0("p", i), easy_plot_plate(eval(parse(text = plates_name[i]))))

p <- plot_grid(p1, p2, p3, NULL, p4, p5, p6, p7, labels = c("B2_933", "B2_444", "C_C11R1", "", "C2_13A", "C2_13B", "D_75", "D_5543"), ncol = 2, nrow = 4)
ggsave("figure/02A-pairs_experiment-plate_layout.pdf", plot = p, width = 12, height = 16)
```

Output pdf `figure/CASEU_pilot2_pairs.pdf` that has the colony morphology ambiguous pairs on DW96 plates layout.

```{r}
pdf("figure/CASEU_pilot2_pairs.pdf", width = 8, height = 6); plot_grid(p1, p1, p2, p3, labels = c("933 P1", "933 P2", "444 P2", "C11R1 P1"), ncol = 2, nrow = 2); dev.off()
```


Plate layout that takes different initial frequencies:

- P1 is 50%:50%.

- P2 and P3 are identical and whose rows are 95% and columns are 5%.

The only exception is plate C11R1 in batch C, which only has one plate.

```{r}
pairs_ambiguous_on_DW96
```

Write the ambiguous pairs location on 96 deep-well plates

```{r}
if (write_all_csv) fwrite(pairs_ambiguous_on_DW96, file = here::here("data/temp/pairs_ambiguous_on_DW96.csv"))
```


