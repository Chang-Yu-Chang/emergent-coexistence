---
title: "R Notebook"
output: html_notebook
---

```{r setup, include=FALSE}
#knitr::opts_chunk()
library(tidyverse)
library(EBImage)
library(reticulate)
folder_main <- "/Users/chang-yu/Dropbox/lab/emergent-coexistence/data/raw/plate_scan/emergent_coexistence_plate_scan_check/"
```


Example pair 

D_T8_C1R2_1
D_T8_C1R2_2 
D_T8_C1R2_5-95_1_2


```{r}
list_images <- tibble(
    image_name = c("D_T8_C1R2_1", "D_T8_C1R2_2", "D_T8_C1R2_5-95_1_2"),
    folder_original = rep(paste0(folder_main, "check/D-00-original/"), 3),
    folder_green = rep(paste0(folder_main, "example/"), 3),
    folder_rolled = rep(paste0(folder_main, "example/"), 3),
    folder_watershed = rep(paste0(folder_main, "example/"), 3),
    folder_red = rep(paste0(folder_main, "example/"), 3),
    folder_blue = rep(paste0(folder_main, "example/"), 3)
)

i = 3
image_name <- list_images$image_name[i]
folder_original <- list_images$folder_original[i]
folder_green <- list_images$folder_green[i]
folder_red <- list_images$folder_red[i]
folder_blue <- list_images$folder_blue[i]
folder_rolled <- list_images$folder_rolled[i]
folder_watershed <- list_images$folder_rolled[i]
```

# 0. original image

```{r}
image_original <- readImage(paste0(folder_original, image_name, ".tiff"))
writeImage(image_original, paste0(folder_green, image_name, "-00-original.tiff"))
display(image_original, method = "raster")
```

# 1. Green channel

```{r}
temp <- image_original
colorMode(temp) = Grayscale
image_green <- temp[,,2]
writeImage(image_green, paste0(folder_green, image_name, "-01-green.tiff"))
display(image_green, method = "raster")
```
Red channel

```{r}
temp <- image_original
colorMode(temp) = Grayscale
image_red <- temp[,,1]
writeImage(image_red, paste0(folder_red, image_name, "-11-red.tiff"))
display(image_red, method = "raster")
```

Blue channel

```{r}
temp <- image_original
colorMode(temp) = Grayscale
image_blue <- temp[,,1]
writeImage(image_blue, paste0(folder_blue, image_name, "-21-blue.tiff"))
display(image_blue, method = "raster")
```




# 2. Rolling ball

Python code from `rolling_ball.py`

```{r}
py$file_green <- paste0(folder_green, image_name, ".tiff")
py$file_rolled <- paste0(folder_rolled, image_name, "-02-rolled.tiff")
```

The R variables should be passed to python but somehow failed. Not sure where the problem is from, probably reticualte. 20220902 use the externally generated rolled images.

```{python}
import imageio
import os
import sys
import skimage
from skimage import data, restoration, util, io, color

def rolling_ball_light(image):
    # 2. invert the image
    image_inverted = util.invert(image)
    
    # 3. rolling ball
    background_inverted = restoration.rolling_ball(image_inverted, radius = 80, num_threads = 10)
    
    # 4. invert the result
    image_rolled_inverted = image_inverted - background_inverted
    image_rolled = util.invert(image_rolled_inverted)
    return image_rolled
    
image = io.imread(file_green)
image_rolled = rolling_ball_light(image)
io.imsave(file_rolled, image_rolled)
```

Display the rolled result

```{r}
image_rolled <- readImage(paste0(folder_rolled, image_name, "-02-rolled.tiff"))
display(image_rolled, method = "raster")
```



# 3. Thresholding

Here because the images have undergone gray scale and background subtraction so I apply a global threshold to the image

```{r}
threshold <- otsu(image_rolled)
image_thresholded <- image_rolled < threshold
display(image_thresholded, method = "raster")
```

# 4. Detect round shaped object and remove super small size

To select potential colonies: area, perimeter, and circularity.

This step is implemented here to prevent over segmentation and reduce segmentation load

As you can see here, attached objects are not divided yet

```{r}
image_object <- bwlabel(image_thresholded)
object_shape <- computeFeatures.shape(image_object) %>% as_tibble(rownames = "ObjectID")

object_shape_round <- object_shape %>%
    # Area
    filter(s.area > 500 & s.area < 500000) %>%
    # Roundness = 1 means a perfect circle
    mutate(Roundness = (s.radius.max - s.radius.min)/2) %>%
    filter(Roundness > 0.1 & Roundness < 50) %>%
    # Circularity = 1 means a perfect circle and goes down to 0 for non-cicular shapes
    mutate(Circularity = 4 * pi * s.area / s.perimeter^2) %>%
    filter(Circularity > 0.3) %>%
    arrange(desc(s.area))
object_ID_nonround <- which(!(object_shape$ObjectID %in% object_shape_round$ObjectID))

image_round <- rmObjects(image_object, object_ID_nonround, reenumerate = F)
display(colorLabels(image_round), method = "raster")
```

# 5. Distance map

The distance map contains for each pixel the distance to the nearest background pixe


```{r}
image_distancemap <- distmap(image_round)
display(normalize(image_distancemap), method = "raster")
```

# 6. Watershed

This is the actual segmentation step. Here the adjacent objects are better distinguished

```{r}
image_watershed <- watershed(image_distancemap, tolerance = 1)
display(colorLabels(image_watershed), method = "raster")
```



# Output the example

```{r}
# writeImage(image_original, paste0(folder_main, "example/", image_name, "-00-original.tiff"))
# writeImage(image_green, paste0(folder_main, "example/", image_name, "-01-green.tiff"))
writeImage(image_rolled, paste0(folder_main, "example/", image_name, "-02-rolled.tiff"))
writeImage(image_thresholded, paste0(folder_main, "example/", image_name, "-03-threshold.tiff"))
#writeImage(colorLabels(image_object), paste0(folder_main, "example/", image_name, "-03a-object.tiff"))
writeImage(image_round, paste0(folder_main, "example/", image_name, "-04-round_object.tiff"))
writeImage(normalize(image_distancemap), paste0(folder_main, "example/", image_name, "-05-distance_map.tiff"))
writeImage(colorLabels(image_watershed), paste0(folder_main, "example/", image_name, "-06-watershed.tiff"))
```












